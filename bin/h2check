#!/usr/bin/env node

var util = require('util'),
    path = require('path'),
    spawn = require('child_process').spawn;

var argv = require('commander')
  .option('-p, --port <value>', 'target port', 80)
  .option('-h, --host <value>', 'target host', '127.0.0.1')
  .parse(process.argv);

var files = [
  '3_5_connection_preface.js',
  '4_2_frame_size.js',
  '4_3_header_compression_and_decompression.js',
  '5_1_stream_states.js',
  '5_4_error_handling.js',
  '6_1_data.js',
  '6_2_headers.js',
  '6_3_priority.js',
  '6_4_rst_stream.js',
  '6_5_settings.js',
  '6_7_ping.js',
  '6_8_goaway.js',
  '6_9_window_update.js'
];

var processArgs = [
  path.resolve(__dirname, '../node_modules/.bin/_mocha')
]

files.forEach(function (file) {
  processArgs.push(path.resolve(__dirname, '../test/' + file));
});

var port = argv.port;
var host = argv.host;

process.env.H2CHECK_PORT = port;
process.env.H2CHECK_HOST = host;

var proc = spawn(process.argv[0], processArgs, { customFds: [0,1,2] });
proc.on('exit', function (code, signal) {
  process.on('exit', function(){
    if (signal) {
      process.kill(process.pid, signal);
    } else {
      process.exit(code);
    }
  });
});
